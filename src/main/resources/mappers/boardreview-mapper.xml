<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.kh.laf.board.model.mapper.ReviewMapper">

	
	<!-- ReviewList -->
     <select id="reviewList" resultType="Review">
        SELECT DISTINCT  r.review_no, m.member_id, 
        				 r.review_content, 
        				 r.review_create_date, 
        				 r.review_score, 
        				 r.order_no, 
        				 r.product_no, 
        				 r.option_no, 
        				 o.order_uno,
        				 `count`, 
        				 TRUNCATE((SELECT AVG(review_score) FROM review sr WHERE r.product_no =sr.product_no),1) review_score_avg, 
        				 (SELECT COUNT(*) FROM review rc WHERE rc.product_no=r.product_no) review_Count 
        FROM review r LEFT JOIN `order` o ON r.order_no =o.order_no 
        			  LEFT JOIN `member` m ON o.member_no = m.member_no 
        			  LEFT JOIN order_product op ON o.order_no=op.order_no
    </select>
    
	<!-- 특정 상품에 대한 모든 리뷰 조회 -->
	<select id="reviewProductList" resultType="Review">
	    SELECT	r.review_no,
	    		m.member_id, 
	    		r.review_content, 
	    		r.review_create_date, 
	    		r.review_score, 
	    		r.order_no, 
	    		r.product_no, 
	    		r.option_no, 
	    		o.order_uno,
	    		`count`, 
	    		TRUNCATE(
	    			(SELECT AVG(review_score)
	    			 FROM 	review sr 
	    			 WHERE 	r.product_no = sr.product_no), 1) review_score_avg, 
	    		(SELECT COUNT(*) FROM review rc WHERE rc.product_no=r.product_no) review_Count
	    FROM 	review r LEFT JOIN `order` o ON r.order_no =o.order_no 
	    			     LEFT JOIN `member` m ON o.member_no = m.member_no 
	    			     LEFT JOIN order_product op ON o.order_no=op.order_no
	    WHERE 	r.product_no = ${productNo};
	</select>
	
	<!-- 특정 상품에 대한 리뷰 개수 조회 -->
	<select id="selectReviewProductCount" resultType="Review">
	    SELECT	count(*)
	    FROM 	`review`
	    WHERE 	product_no = ${productNo}
	</select>
    
 	<!-- ReviewOption -->
    <select id="reviewOption" resultType="Option">
        SELECT * FROM `option` o WHERE option_no=#{optionNo}
    </select>
    

    
    <!-- 상품조회 -->
    <select id="reviewProduct" resultType="Product">
		SELECT `product`.product_no,
				product_name,
				product_price,
				product_sale_price,
				product_sale,
				product_point,
				product_state,
				DATE_FORMAT(product_date, '%Y-%m-%d') AS product_date,
				img_path AS thumbnail_path
		FROM   `product`
				JOIN `product_img` ON `product`.product_no = `product_img`.product_no
		WHERE  `product`.product_no = #{productNo}
				AND thumb_fl  = 'Y'
	</select>
	
	<!-- 개별 Review 조회 -->
     <select id="detailReview" resultType="Review">
        SELECT DISTINCT  r.review_no, 
        				 m.member_id, 
        				 r.review_content, 
        				 DATE_FORMAT(r.review_create_date, '%Y-%m-%d') AS review_create_date, 
        				 r.review_score, 
        				 r.order_no, 
        				 r.product_no, 
        				 r.option_no, 
        				 o.order_uno,
        				 `count`, 
        				 m.member_name,
        				 TRUNCATE((SELECT AVG(review_score) FROM review sr WHERE r.product_no =sr.product_no),1) review_score_avg, 
        				 (SELECT COUNT(*) FROM review rc WHERE rc.product_no=r.product_no) review_Count 
        FROM review r LEFT JOIN `order` o ON r.order_no =o.order_no 
        			  LEFT JOIN `member` m ON o.member_no = m.member_no 
        			  LEFT JOIN order_product op ON o.order_no=op.order_no
        WHERE r.review_no = #{reviewNo}
    </select>
    
    <update id="updateReview">
		UPDATE `review`	SET review_content=#{reviewContent}, review_score= #{reviewScore} WHERE review_no = #{reviewNo}
	</update>
    
    <update id="updateImage">
		UPDATE `review_img`	SET review_no=#{reviewNo}, review_path= #{reviewPath} WHERE review_no = #{reviewNo}
	</update>
    
    
    

</mapper>

